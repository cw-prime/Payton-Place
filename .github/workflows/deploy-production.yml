name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to payton-place.mbartonportfolio.space
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "ğŸš€ Starting deployment to production..."

            # Navigate to project directory
            cd /opt/apps/payton-place

            # Pull latest changes
            echo "ğŸ“¥ Pulling latest code from main branch..."
            git pull origin main

            # Build Frontend
            echo "ğŸ”¨ Building frontend..."
            cd frontend
            npm install
            npm run build -- --mode production

            # Build Backend
            echo "ğŸ”¨ Building backend..."
            cd ../backend
            npm install
            npm run build

            # Restart PM2
            echo "ğŸ”„ Restarting backend with PM2..."
            cd ..
            pm2 restart payton-place-backend

            # Check PM2 status
            echo "âœ… Checking PM2 status..."
            pm2 status

            echo "ğŸ‰ Deployment to production complete!"
            echo "ğŸŒ Site: https://payton-place.mbartonportfolio.space"

      - name: Verify Deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          sleep 5
          curl -f https://payton-place.mbartonportfolio.space || echo "âš ï¸ Site verification failed"

      - name: Notify Success
        if: success()
        run: |
          echo "âœ… Production deployment successful!"
          echo "Site: https://payton-place.mbartonportfolio.space"

      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ Production deployment failed!"
          echo "Check logs for details"
